<!DOCTYPE html>
<html>
<head>
    <title>Collect the Gems!</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <style>
        body {
            font-family: "Press Start 2P", sans-serif;
        }
        #game-container {
            position: relative;
        }
        canvas {
        background: url(background.png);
        background-size: cover;
        }
        canvas, #counter, #game-start, #game-over {
        position: absolute;
        top: 0px;
        left: 0px;  
        }
        canvas, #game-start, #game-over {
        border: 1px solid gray;
        width: 854px;
        height: 480px;
        }
        #counter text {
            font-size: 130%;
            fill: white;
            stroke: black;
            stroke-width: 1px;
        }
        #game-start text {
            font-size: 150%;
            fill: white;
            text-anchor: middle;
        }
        #game-start #game-title {
            font-size: 400%;
            fill: url(#title-fill);
            stroke: black;
        }
        #game-over text {
            font-size: 120%;
            fill: url(#game-over-fill);
            text-anchor: middle;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="854px" height="480px"></canvas>
        <svg xmlns="http://www.w3.org/2000/svg" id="game-start">
            <defs>
                <linearGradient id="title-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0.2" stop-color="red" />
                    <stop offset="0.4" stop-color="yellow" />
                    <stop offset="0.6" stop-color="green" />
                    <stop offset="0.8" stop-color="purple" />
                </linearGradient>
            </defs>
            <text id="game-title" x="50%" y="45%">GEM RUSH!</text>
            <text x="50%" y="60%">Click here to start the game</text>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="game-over" style="display: none">
            <defs>
                <linearGradient id="game-over-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="red" />
                    <stop offset="0.5" stop-color="yellow" />
                    <stop offset="1" stop-color="red" />
                </linearGradient>
            </defs>
            <text x="50%" y="50%">
                Time's up! You have collected
                <tspan id="final-gems">0</tspan>
                gem(s).
            </text>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
            <text x="10" y="35">
                TIME:<tspan id="time-remaining">20</tspan>
            </text>
        </svg>
    </div>
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script> 
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="bounding_box.js"></script>
    <script src="sprite.js"></script>
    <script src="gem_player.js"></script>
    <script src="gem_gem.js"></script>
    <script src="gem_fire.js"></script>
    <script src="scripts/socket.js"></script>
    <script src="scripts/ui.js"></script> 
    <script>
    $(function() {
        const canvas = document.getElementById("gameCanvas");
        const context = canvas.getContext("2d");
        const socket = io('http://localhost:8000');
        const gameArea = BoundingBox(context, 165, 60, 420, 800);
        const walls = [BoundingBox(context,310,200,320,800)];


        let gameStartTime = 0;   
        const totalGameTime = 20; 
        let player1 = Player(context, 427, 240, gameArea,walls); // this player
        let player2 = Player(context, 427, 240, gameArea,walls); //other playrt
        let gems = [Gem(context, 427, 350, "green") ];
        const cornerPoints = gameArea.getPoints();
        let collectedGems = 0;
        let fires = [
            Fire(context, cornerPoints.topLeft[0], cornerPoints.topLeft[1], "realfire"),
            Fire(context, cornerPoints.topRight[0], cornerPoints.topRight[1], "realfire"), 
            Fire(context, cornerPoints.bottomLeft[0], cornerPoints.bottomLeft[1], "realfire"), 
            Fire(context, cornerPoints.bottomRight[0], cornerPoints.bottomRight[1], "realfire"), 
            ]
        socket.onmessage = function(event) {

            const data = JSON.parse(event.data);
            players = data.players;
            Object.assign(players, {
                player1: { name: "Alice", score: 0 },
                player2: { name: "Bob", score: 0 }
            });
            drawGame(0);
        };

        function drawGame(now) {
            if (gameStartTime == 0) gameStartTime = now;
            /* Update the time remaining */
            const gameTimeSoFar = now - gameStartTime;
            const timeRemaining = Math.ceil((totalGameTime * 1000 - gameTimeSoFar) / 1000);
            $("#time-remaining").text(timeRemaining);
            if(gameTimeSoFar==0){
                // gem.randomize(gameArea);
                // sounds.background.play();
            }

            context.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < walls.length; i++) {
                context.fillStyle = 'white'; // 设置填充颜色
                context.fillRect(200,330,600,10); 
            }
            gems.forEach(gem => {
                if (!gem.collected) {
                    gem.update(now);
                    gem.draw();
                }
            });
            player1.update(now)
            player1.draw();
            player2.update(now)
            player2.draw();
            fires.forEach(f => f.update(now));
            fires.forEach(f => f.draw());
            requestAnimationFrame(drawGame);
            // collection part need to be change 
        }


        $("#game-start").on("click", function() {
            $("#game-start").hide();
            // Start game logic
            $(document).on("mousedown", function(event) {
    /* 获取鼠标点击位置 */
                let mouseX = event.clientX; // 获取鼠标的 X 坐标
                let mouseY = event.clientY; // 获取鼠标的 Y 坐标
                /* 处理鼠标按下，移动玩家到点击位置 */
                player1.moveTo(mouseX, mouseY); // 假设 player1 有 moveTo 方法
                // io.exit()
                const content = {
                    x: mouseX,
                    y: mouseY,

                };
                postMessage(content);
                
            });
            requestAnimationFrame(drawGame);
        });
    });
    </script>
</body>
</html>
